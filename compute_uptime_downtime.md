# The logic for computing the hours overlap and uptime/downtime

## 1. Database contains the following tables:
> csv -> postgresql Database

**1. store_status**
```excel
store_id	status	timestamp_utc
0	8419537941919820732	active	2023-01-22 12:09:39.388884 UTC
1	54515546588432327	active	2023-01-24 09:06:42.605777 UTC
2	8377465688456570187	active	2023-01-24 09:07:26.441407 UTC
3	5955337179846162144	active	2023-01-24 09:08:07.634899 UTC
4	1169347689335808384	active	2023-01-24 09:08:18.436854 UTC
...
```
**2. menu_hours**
```excel
store_id	day	start_time_local	end_time_local
0	1481966498820158979	4	00:00:00	00:10:00
1	1481966498820158979	2	00:00:00	00:10:00
2	1481966498820158979	0	00:00:00	00:10:00
3	1481966498820158979	1	00:00:00	00:10:00
4	1481966498820158979	5	00:00:00	00:10:00
...
```
**3. store_timezone**
```excel
store_id	timezone_str
0	8139926242460185114	Asia/Beirut
1	5415949628544298339	America/Boise
2	3408529570017053440	America/Denver
3	9055649751952768824	America/Denver
4	4428372089193592098	America/Denver
...
```

## 2. Current UTC time
> get the current UTC time and last 1hr, 24hr, 7days times
```python
CURRENT_UTCTIME = datetime.datetime.utcnow()
```
```python
LASK_HR_DATETIME = CURRENT_DATETIME_SET - datetime.timedelta(hours=1)
LASK_24HR_DATETIME = CURRENT_DATETIME_SET - datetime.timedelta(hours=24)
LASK_7DAYS_DATETIME = CURRENT_DATETIME_SET - datetime.timedelta(days=7)
```

## 3. Get all the unique store_ids = smData.get_store_ids()
> To compute the uptime/downtime for each `store_id`
```sql
SELECT distinct store_id
FROM store_status;
```

## 4. Generate the `store_status_compute` dataframe whith ranged active/inactive status

### 4.1. Get the menu_hours data for each `store_id` and convert the dataframe to dictionary and if no data then set 'America/Chicago'
```sql
SELECT timezone_str
FROM store_timezone
WHERE store_id = store_id;
```
```python
timezone_str = store_timezone['timezone_str'][0] if len(store_timezone) > 0 else 'America/Chicago'
```

### 4.2. Get the last 7days store_status data for each `store_id` and convert the timestamp_utc to timestamp_local
```sql
SELECT status, timestamp_utc::timestamp at time zone 'store_timezone' as timestamp_local
FROM store_status
WHERE store_id = store_id
order by timestamp_local;
```
let's this dataframe be`store_status_compute`
> eg: `store_id` = 7832590722878413297
> old Table -> new DataFrame
> ```excel
>        status              timestamp_utc                    status                  timestamp_local
> 0    inactive 2023-01-18 00:09:50.541419             0    inactive 2023-01-18 05:09:50.541419+00:00
> 1    inactive 2023-01-18 01:10:07.117301             1    inactive 2023-01-18 06:10:07.117301+00:00
> 2    inactive 2023-01-18 02:08:06.892883             2    inactive 2023-01-18 07:08:06.892883+00:00
> 3    inactive 2023-01-18 03:01:20.661140             3    inactive 2023-01-18 08:01:20.661140+00:00
> 4    inactive 2023-01-18 04:09:04.075382             4    inactive 2023-01-18 09:09:04.075382+00:00
> ..        ...                        ...    --->     ..        ...                              ...
> 240    active 2023-01-25 16:06:05.179555             240    active 2023-01-25 21:06:05.179555+00:00
> 241    active 2023-01-25 17:01:19.496218             241    active 2023-01-25 22:01:19.496218+00:00
> 242    active 2023-01-25 17:06:45.790348             242    active 2023-01-25 22:06:45.790348+00:00
> 243    active 2023-01-25 18:00:54.239712             243    active 2023-01-25 23:00:54.239712+00:00
> 244    active 2023-01-25 18:03:17.170336             244    active 2023-01-25 23:03:17.170336+00:00
> ```


### 4.3. `store_status_compute` add `start_time` & `end_time`
> By doing this we can get the time range for each status
```python
store_status_TimeRange['start_time'] = store_status_TimeRange['timestamp_local'].shift(1)
store_status_TimeRange['end_time'] = store_status_TimeRange['timestamp_local']
```
> eg: `store_id` = 7832590722878413297
> ```excel
>        status                  timestamp_local              status                  timestamp_local                       start_time                         end_time
> 0    inactive 2023-01-18 05:09:50.541419+00:00            0    inactive 2023-01-18 05:09:50.541419+00:00                              NaT 2023-01-18 05:09:50.541419+00:00
> 1    inactive 2023-01-18 06:10:07.117301+00:00            1    inactive 2023-01-18 06:10:07.117301+00:00 2023-01-18 05:09:50.541419+00:00 2023-01-18 06:10:07.117301+00:00
> 2    inactive 2023-01-18 07:08:06.892883+00:00            2    inactive 2023-01-18 07:08:06.892883+00:00 2023-01-18 06:10:07.117301+00:00 2023-01-18 07:08:06.892883+00:00
> 3    inactive 2023-01-18 08:01:20.661140+00:00            3    inactive 2023-01-18 08:01:20.661140+00:00 2023-01-18 07:08:06.892883+00:00 2023-01-18 08:01:20.661140+00:00
> 4    inactive 2023-01-18 09:09:04.075382+00:00            4    inactive 2023-01-18 09:09:04.075382+00:00 2023-01-18 08:01:20.661140+00:00 2023-01-18 09:09:04.075382+00:00
> ..        ...                              ...    -->     ..        ...                              ...                              ...                              ...
> 240    active 2023-01-25 21:06:05.179555+00:00            240    active 2023-01-25 21:06:05.179555+00:00 2023-01-25 21:00:44.204098+00:00 2023-01-25 21:06:05.179555+00:00
> 241    active 2023-01-25 22:01:19.496218+00:00            241    active 2023-01-25 22:01:19.496218+00:00 2023-01-25 21:06:05.179555+00:00 2023-01-25 22:01:19.496218+00:00
> 242    active 2023-01-25 22:06:45.790348+00:00            242    active 2023-01-25 22:06:45.790348+00:00 2023-01-25 22:01:19.496218+00:00 2023-01-25 22:06:45.790348+00:00
> 243    active 2023-01-25 23:00:54.239712+00:00            243    active 2023-01-25 23:00:54.239712+00:00 2023-01-25 22:06:45.790348+00:00 2023-01-25 23:00:54.239712+00:00
> 244    active 2023-01-25 23:03:17.170336+00:00            244    active 2023-01-25 23:03:17.170336+00:00 2023-01-25 23:00:54.239712+00:00 2023-01-25 23:03:17.170336+00:00
> ```

### 4.4. Add `active_hours` & `inactive_hours` columns
> By doing this we can get the time range for each status
```python
store_status_TimeRange['active_hours'] = store_status_TimeRange.apply(lambda x: x['end_time'] - x['start_time'] if x['status'] == 'active' else datetime.timedelta(hours=0), axis=1)
store_status_TimeRange['inactive_hours'] = store_status_TimeRange.apply(lambda x: x['end_time'] - x['start_time'] if x['status'] == 'inactive' else datetime.timedelta(hours=0), axis=1)
```

> eg: `store_id` = 7832590722878413297
> ```excel
>   status                  timestamp_local                       start_time                         end_time
> 0    inactive 2023-01-18 05:09:50.541419+00:00                              NaT 2023-01-18 05:09:50.541419+00:00
> 1    inactive 2023-01-18 06:10:07.117301+00:00 2023-01-18 05:09:50.541419+00:00 2023-01-18 06:10:07.117301+00:00
> 2    inactive 2023-01-18 07:08:06.892883+00:00 2023-01-18 06:10:07.117301+00:00 2023-01-18 07:08:06.892883+00:00
> 3    inactive 2023-01-18 08:01:20.661140+00:00 2023-01-18 07:08:06.892883+00:00 2023-01-18 08:01:20.661140+00:00
> 4    inactive 2023-01-18 09:09:04.075382+00:00 2023-01-18 08:01:20.661140+00:00 2023-01-18 09:09:04.075382+00:00
> ..        ...                              ...                              ...                              ...
> 240    active 2023-01-25 21:06:05.179555+00:00 2023-01-25 21:00:44.204098+00:00 2023-01-25 21:06:05.179555+00:00
> 241    active 2023-01-25 22:01:19.496218+00:00 2023-01-25 21:06:05.179555+00:00 2023-01-25 22:01:19.496218+00:00
> 242    active 2023-01-25 22:06:45.790348+00:00 2023-01-25 22:01:19.496218+00:00 2023-01-25 22:06:45.790348+00:00
> 243    active 2023-01-25 23:00:54.239712+00:00 2023-01-25 22:06:45.790348+00:00 2023-01-25 23:00:54.239712+00:00
> 244    active 2023-01-25 23:03:17.170336+00:00 2023-01-25 23:00:54.239712+00:00 2023-01-25 23:03:17.170336+00:00
> ```
>   |
>   â†“
> ```excel
>        status                  timestamp_local                       start_time                         end_time           active_hours         inactive_hours
> 0    inactive 2023-01-18 05:09:50.541419+00:00                              NaT 2023-01-18 05:09:50.541419+00:00        0 days 00:00:00                    NaT
> 1    inactive 2023-01-18 06:10:07.117301+00:00 2023-01-18 05:09:50.541419+00:00 2023-01-18 06:10:07.117301+00:00        0 days 00:00:00 0 days 01:00:16.575882
> 2    inactive 2023-01-18 07:08:06.892883+00:00 2023-01-18 06:10:07.117301+00:00 2023-01-18 07:08:06.892883+00:00        0 days 00:00:00 0 days 00:57:59.775582
> 3    inactive 2023-01-18 08:01:20.661140+00:00 2023-01-18 07:08:06.892883+00:00 2023-01-18 08:01:20.661140+00:00        0 days 00:00:00 0 days 00:53:13.768257
> 4    inactive 2023-01-18 09:09:04.075382+00:00 2023-01-18 08:01:20.661140+00:00 2023-01-18 09:09:04.075382+00:00        0 days 00:00:00 0 days 01:07:43.414242
> ..        ...                              ...                              ...                              ...                    ...                    ...
> 240    active 2023-01-25 21:06:05.179555+00:00 2023-01-25 21:00:44.204098+00:00 2023-01-25 21:06:05.179555+00:00 0 days 00:05:20.975457        0 days 00:00:00
> 241    active 2023-01-25 22:01:19.496218+00:00 2023-01-25 21:06:05.179555+00:00 2023-01-25 22:01:19.496218+00:00 0 days 00:55:14.316663        0 days 00:00:00
> 242    active 2023-01-25 22:06:45.790348+00:00 2023-01-25 22:01:19.496218+00:00 2023-01-25 22:06:45.790348+00:00 0 days 00:05:26.294130        0 days 00:00:00
> 243    active 2023-01-25 23:00:54.239712+00:00 2023-01-25 22:06:45.790348+00:00 2023-01-25 23:00:54.239712+00:00 0 days 00:54:08.449364        0 days 00:00:00
> 244    active 2023-01-25 23:03:17.170336+00:00 2023-01-25 23:00:54.239712+00:00 2023-01-25 23:03:17.170336+00:00 0 days 00:02:22.930624        0 days 00:00:00
> ```

### 4.5. Now remove the time intervals that are not in the `menu_hours`
```python
def check_time_in_range(time, weekday):
    for i in range(0, len(menu_hours[weekday])):
        if time >= menu_hours[weekday][i][0] and time <= menu_hours[weekday][i][1]:
            return False
    return True

sub_status_timerange = sub_status_timerange.drop(sub_status_timerange[(sub_status_timerange['start_time']
                                                                        .apply(lambda x: check_time_in_range(x.time(),x.weekday())) &
                                                                        sub_status_timerange['end_time']
                                                                        .apply(lambda x: check_time_in_range(x.time(),x.weekday())))].index)
```

> eg. lets take the current time as *'2023-01-25 20:00:00.000000+00:00'* and if we want the last 24hrs data, then we need to remove the time intervals that are not in the menu hours for the current day. take `store_id` = 7832590722878413297 as an example, we have the following time intervals:
> ```excel
>        status                  timestamp_local                       start_time                         end_time           active_hours         inactive_hours
> 187    active 2023-01-24 20:00:49.407196+00:00 2023-01-24 19:04:28.032808+00:00 2023-01-24 20:00:49.407196+00:00 0 days 00:56:21.374388        0 days 00:00:00
> 188    active 2023-01-24 20:03:37.554265+00:00 2023-01-24 20:00:49.407196+00:00 2023-01-24 20:03:37.554265+00:00 0 days 00:02:48.147069        0 days 00:00:00
> 189    active 2023-01-24 21:00:56.058718+00:00 2023-01-24 20:03:37.554265+00:00 2023-01-24 21:00:56.058718+00:00 0 days 00:57:18.504453        0 days 00:00:00
> 190    active 2023-01-24 21:03:02.379032+00:00 2023-01-24 21:00:56.058718+00:00 2023-01-24 21:03:02.379032+00:00 0 days 00:02:06.320314        0 days 00:00:00
> 191    active 2023-01-24 22:00:53.298806+00:00 2023-01-24 21:03:02.379032+00:00 2023-01-24 22:00:53.298806+00:00 0 days 00:57:50.919774        0 days 00:00:00
> 192    active 2023-01-24 22:03:00.635256+00:00 2023-01-24 22:00:53.298806+00:00 2023-01-24 22:03:00.635256+00:00 0 days 00:02:07.336450        0 days 00:00:00
> 193    active 2023-01-24 23:00:43.975206+00:00 2023-01-24 22:03:00.635256+00:00 2023-01-24 23:00:43.975206+00:00 0 days 00:57:43.339950        0 days 00:00:00
> 194    active 2023-01-24 23:03:39.074389+00:00 2023-01-24 23:00:43.975206+00:00 2023-01-24 23:03:39.074389+00:00 0 days 00:02:55.099183        0 days 00:00:00
> 195    active 2023-01-25 00:00:47.123794+00:00 2023-01-24 23:03:39.074389+00:00 2023-01-25 00:00:47.123794+00:00 0 days 00:57:08.049405        0 days 00:00:00
> 196    active 2023-01-25 00:03:15.622430+00:00 2023-01-25 00:00:47.123794+00:00 2023-01-25 00:03:15.622430+00:00 0 days 00:02:28.498636        0 days 00:00:00
> 197    active 2023-01-25 01:00:38.692156+00:00 2023-01-25 00:03:15.622430+00:00 2023-01-25 01:00:38.692156+00:00 0 days 00:57:23.069726        0 days 00:00:00
> 198    active 2023-01-25 01:03:20.492763+00:00 2023-01-25 01:00:38.692156+00:00 2023-01-25 01:03:20.492763+00:00 0 days 00:02:41.800607        0 days 00:00:00
> 199    active 2023-01-25 02:01:00.135959+00:00 2023-01-25 01:03:20.492763+00:00 2023-01-25 02:01:00.135959+00:00 0 days 00:57:39.643196        0 days 00:00:00
> 200    active 2023-01-25 02:03:51.675653+00:00 2023-01-25 02:01:00.135959+00:00 2023-01-25 02:03:51.675653+00:00 0 days 00:02:51.539694        0 days 00:00:00
> 201    active 2023-01-25 03:00:42.831489+00:00 2023-01-25 02:03:51.675653+00:00 2023-01-25 03:00:42.831489+00:00 0 days 00:56:51.155836        0 days 00:00:00
> 202    active 2023-01-25 03:02:24.554455+00:00 2023-01-25 03:00:42.831489+00:00 2023-01-25 03:02:24.554455+00:00 0 days 00:01:41.722966        0 days 00:00:00
> 203    active 2023-01-25 03:04:02.673874+00:00 2023-01-25 03:02:24.554455+00:00 2023-01-25 03:04:02.673874+00:00 0 days 00:01:38.119419        0 days 00:00:00
> 204    active 2023-01-25 03:06:20.649872+00:00 2023-01-25 03:04:02.673874+00:00 2023-01-25 03:06:20.649872+00:00 0 days 00:02:17.975998        0 days 00:00:00
> 205    active 2023-01-25 04:00:53.162329+00:00 2023-01-25 03:06:20.649872+00:00 2023-01-25 04:00:53.162329+00:00 0 days 00:54:32.512457        0 days 00:00:00
> 206    active 2023-01-25 04:03:19.361836+00:00 2023-01-25 04:00:53.162329+00:00 2023-01-25 04:03:19.361836+00:00 0 days 00:02:26.199507        0 days 00:00:00
> 207    active 2023-01-25 05:01:01.402600+00:00 2023-01-25 04:03:19.361836+00:00 2023-01-25 05:01:01.402600+00:00 0 days 00:57:42.040764        0 days 00:00:00
> 208    active 2023-01-25 05:02:54.347461+00:00 2023-01-25 05:01:01.402600+00:00 2023-01-25 05:02:54.347461+00:00 0 days 00:01:52.944861        0 days 00:00:00
> 209    active 2023-01-25 06:00:53.959238+00:00 2023-01-25 05:02:54.347461+00:00 2023-01-25 06:00:53.959238+00:00 0 days 00:57:59.611777        0 days 00:00:00
> 210    active 2023-01-25 06:03:16.044936+00:00 2023-01-25 06:00:53.959238+00:00 2023-01-25 06:03:16.044936+00:00 0 days 00:02:22.085698        0 days 00:00:00
> 211  inactive 2023-01-25 07:00:52.899424+00:00 2023-01-25 06:03:16.044936+00:00 2023-01-25 07:00:52.899424+00:00        0 days 00:00:00 0 days 00:57:36.854488
> 212  inactive 2023-01-25 07:03:21.459324+00:00 2023-01-25 07:00:52.899424+00:00 2023-01-25 07:03:21.459324+00:00        0 days 00:00:00 0 days 00:02:28.559900
> 213  inactive 2023-01-25 08:00:47.142792+00:00 2023-01-25 07:03:21.459324+00:00 2023-01-25 08:00:47.142792+00:00        0 days 00:00:00 0 days 00:57:25.683468
> 214  inactive 2023-01-25 08:02:38.811284+00:00 2023-01-25 08:00:47.142792+00:00 2023-01-25 08:02:38.811284+00:00        0 days 00:00:00 0 days 00:01:51.668492
> 215    active 2023-01-25 09:00:55.285348+00:00 2023-01-25 08:02:38.811284+00:00 2023-01-25 09:00:55.285348+00:00 0 days 00:58:16.474064        0 days 00:00:00
> 216    active 2023-01-25 09:02:40.740800+00:00 2023-01-25 09:00:55.285348+00:00 2023-01-25 09:02:40.740800+00:00 0 days 00:01:45.455452        0 days 00:00:00
> 217    active 2023-01-25 10:01:03.896898+00:00 2023-01-25 09:02:40.740800+00:00 2023-01-25 10:01:03.896898+00:00 0 days 00:58:23.156098        0 days 00:00:00
> 218    active 2023-01-25 10:03:11.056959+00:00 2023-01-25 10:01:03.896898+00:00 2023-01-25 10:03:11.056959+00:00 0 days 00:02:07.160061        0 days 00:00:00
> 219    active 2023-01-25 11:01:03.078580+00:00 2023-01-25 10:03:11.056959+00:00 2023-01-25 11:01:03.078580+00:00 0 days 00:57:52.021621        0 days 00:00:00
> 220    active 2023-01-25 11:03:30.092721+00:00 2023-01-25 11:01:03.078580+00:00 2023-01-25 11:03:30.092721+00:00 0 days 00:02:27.014141        0 days 00:00:00
> 221    active 2023-01-25 12:00:43.791570+00:00 2023-01-25 11:03:30.092721+00:00 2023-01-25 12:00:43.791570+00:00 0 days 00:57:13.698849        0 days 00:00:00
> 222    active 2023-01-25 12:04:23.893717+00:00 2023-01-25 12:00:43.791570+00:00 2023-01-25 12:04:23.893717+00:00 0 days 00:03:40.102147        0 days 00:00:00
> 223    active 2023-01-25 13:01:19.762596+00:00 2023-01-25 12:04:23.893717+00:00 2023-01-25 13:01:19.762596+00:00 0 days 00:56:55.868879        0 days 00:00:00
> 224    active 2023-01-25 13:04:24.219942+00:00 2023-01-25 13:01:19.762596+00:00 2023-01-25 13:04:24.219942+00:00 0 days 00:03:04.457346        0 days 00:00:00
> 225    active 2023-01-25 14:02:25.817882+00:00 2023-01-25 13:04:24.219942+00:00 2023-01-25 14:02:25.817882+00:00 0 days 00:58:01.597940        0 days 00:00:00
> 226    active 2023-01-25 14:08:31.056771+00:00 2023-01-25 14:02:25.817882+00:00 2023-01-25 14:08:31.056771+00:00 0 days 00:06:05.238889        0 days 00:00:00
> 227    active 2023-01-25 15:01:54.946614+00:00 2023-01-25 14:08:31.056771+00:00 2023-01-25 15:01:54.946614+00:00 0 days 00:53:23.889843        0 days 00:00:00
> 228    active 2023-01-25 15:09:32.641347+00:00 2023-01-25 15:01:54.946614+00:00 2023-01-25 15:09:32.641347+00:00 0 days 00:07:37.694733        0 days 00:00:00
> 229    active 2023-01-25 16:02:04.919926+00:00 2023-01-25 15:09:32.641347+00:00 2023-01-25 16:02:04.919926+00:00 0 days 00:52:32.278579        0 days 00:00:00
> 230    active 2023-01-25 16:08:29.440442+00:00 2023-01-25 16:02:04.919926+00:00 2023-01-25 16:08:29.440442+00:00 0 days 00:06:24.520516        0 days 00:00:00
> 231    active 2023-01-25 17:02:30.620246+00:00 2023-01-25 16:08:29.440442+00:00 2023-01-25 17:02:30.620246+00:00 0 days 00:54:01.179804        0 days 00:00:00
> 232    active 2023-01-25 17:08:16.111918+00:00 2023-01-25 17:02:30.620246+00:00 2023-01-25 17:08:16.111918+00:00 0 days 00:05:45.491672        0 days 00:00:00
> 233    active 2023-01-25 18:03:09.134952+00:00 2023-01-25 17:08:16.111918+00:00 2023-01-25 18:03:09.134952+00:00 0 days 00:54:53.023034        0 days 00:00:00
> 234    active 2023-01-25 18:07:56.743191+00:00 2023-01-25 18:03:09.134952+00:00 2023-01-25 18:07:56.743191+00:00 0 days 00:04:47.608239        0 days 00:00:00
> 235    active 2023-01-25 19:02:52.698802+00:00 2023-01-25 18:07:56.743191+00:00 2023-01-25 19:02:52.698802+00:00 0 days 00:54:55.955611        0 days 00:00:00
> 236    active 2023-01-25 19:08:09.876675+00:00 2023-01-25 19:02:52.698802+00:00 2023-01-25 19:08:09.876675+00:00 0 days 00:05:17.177873        0 days 00:00:00
> 237    active 2023-01-25 20:01:55.497484+00:00 2023-01-25 19:08:09.876675+00:00 2023-01-25 20:01:55.497484+00:00 0 days 00:53:45.620809        0 days 00:00:00
> ```
> ```excel
>        status                  timestamp_local                       start_time                         end_time           active_hours         inactive_hours
> 187    active 2023-01-24 20:00:49.407196+00:00 2023-01-24 19:04:28.032808+00:00 2023-01-24 20:00:49.407196+00:00 0 days 00:56:21.374388        0 days 00:00:00
> 188    active 2023-01-24 20:03:37.554265+00:00 2023-01-24 20:00:49.407196+00:00 2023-01-24 20:03:37.554265+00:00 0 days 00:02:48.147069        0 days 00:00:00
> 189    active 2023-01-24 21:00:56.058718+00:00 2023-01-24 20:03:37.554265+00:00 2023-01-24 21:00:56.058718+00:00 0 days 00:57:18.504453        0 days 00:00:00
> 190    active 2023-01-24 21:03:02.379032+00:00 2023-01-24 21:00:56.058718+00:00 2023-01-24 21:03:02.379032+00:00 0 days 00:02:06.320314        0 days 00:00:00
> 191    active 2023-01-24 22:00:53.298806+00:00 2023-01-24 21:03:02.379032+00:00 2023-01-24 22:00:53.298806+00:00 0 days 00:57:50.919774        0 days 00:00:00
> 192    active 2023-01-24 22:03:00.635256+00:00 2023-01-24 22:00:53.298806+00:00 2023-01-24 22:03:00.635256+00:00 0 days 00:02:07.336450        0 days 00:00:00
> 193    active 2023-01-24 23:00:43.975206+00:00 2023-01-24 22:03:00.635256+00:00 2023-01-24 23:00:43.975206+00:00 0 days 00:57:43.339950        0 days 00:00:00
> 194    active 2023-01-24 23:03:39.074389+00:00 2023-01-24 23:00:43.975206+00:00 2023-01-24 23:03:39.074389+00:00 0 days 00:02:55.099183        0 days 00:00:00
> 195    active 2023-01-25 00:00:47.123794+00:00 2023-01-24 23:03:39.074389+00:00 2023-01-25 00:00:47.123794+00:00 0 days 00:57:08.049405        0 days 00:00:00
> 196    active 2023-01-25 00:03:15.622430+00:00 2023-01-25 00:00:47.123794+00:00 2023-01-25 00:03:15.622430+00:00 0 days 00:02:28.498636        0 days 00:00:00
> 197    active 2023-01-25 01:00:38.692156+00:00 2023-01-25 00:03:15.622430+00:00 2023-01-25 01:00:38.692156+00:00 0 days 00:57:23.069726        0 days 00:00:00
> 211  inactive 2023-01-25 07:00:52.899424+00:00 2023-01-25 06:03:16.044936+00:00 2023-01-25 07:00:52.899424+00:00        0 days 00:00:00 0 days 00:57:36.854488
> 212  inactive 2023-01-25 07:03:21.459324+00:00 2023-01-25 07:00:52.899424+00:00 2023-01-25 07:03:21.459324+00:00        0 days 00:00:00 0 days 00:02:28.559900
> 213  inactive 2023-01-25 08:00:47.142792+00:00 2023-01-25 07:03:21.459324+00:00 2023-01-25 08:00:47.142792+00:00        0 days 00:00:00 0 days 00:57:25.683468
> 214  inactive 2023-01-25 08:02:38.811284+00:00 2023-01-25 08:00:47.142792+00:00 2023-01-25 08:02:38.811284+00:00        0 days 00:00:00 0 days 00:01:51.668492
> 215    active 2023-01-25 09:00:55.285348+00:00 2023-01-25 08:02:38.811284+00:00 2023-01-25 09:00:55.285348+00:00 0 days 00:58:16.474064        0 days 00:00:00
> 216    active 2023-01-25 09:02:40.740800+00:00 2023-01-25 09:00:55.285348+00:00 2023-01-25 09:02:40.740800+00:00 0 days 00:01:45.455452        0 days 00:00:00
> 217    active 2023-01-25 10:01:03.896898+00:00 2023-01-25 09:02:40.740800+00:00 2023-01-25 10:01:03.896898+00:00 0 days 00:58:23.156098        0 days 00:00:00
> 218    active 2023-01-25 10:03:11.056959+00:00 2023-01-25 10:01:03.896898+00:00 2023-01-25 10:03:11.056959+00:00 0 days 00:02:07.160061        0 days 00:00:00
> 219    active 2023-01-25 11:01:03.078580+00:00 2023-01-25 10:03:11.056959+00:00 2023-01-25 11:01:03.078580+00:00 0 days 00:57:52.021621        0 days 00:00:00
> 220    active 2023-01-25 11:03:30.092721+00:00 2023-01-25 11:01:03.078580+00:00 2023-01-25 11:03:30.092721+00:00 0 days 00:02:27.014141        0 days 00:00:00
> 221    active 2023-01-25 12:00:43.791570+00:00 2023-01-25 11:03:30.092721+00:00 2023-01-25 12:00:43.791570+00:00 0 days 00:57:13.698849        0 days 00:00:00
> 222    active 2023-01-25 12:04:23.893717+00:00 2023-01-25 12:00:43.791570+00:00 2023-01-25 12:04:23.893717+00:00 0 days 00:03:40.102147        0 days 00:00:00
> 223    active 2023-01-25 13:01:19.762596+00:00 2023-01-25 12:04:23.893717+00:00 2023-01-25 13:01:19.762596+00:00 0 days 00:56:55.868879        0 days 00:00:00
> 224    active 2023-01-25 13:04:24.219942+00:00 2023-01-25 13:01:19.762596+00:00 2023-01-25 13:04:24.219942+00:00 0 days 00:03:04.457346        0 days 00:00:00
> 225    active 2023-01-25 14:02:25.817882+00:00 2023-01-25 13:04:24.219942+00:00 2023-01-25 14:02:25.817882+00:00 0 days 00:58:01.597940        0 days 00:00:00
> 226    active 2023-01-25 14:08:31.056771+00:00 2023-01-25 14:02:25.817882+00:00 2023-01-25 14:08:31.056771+00:00 0 days 00:06:05.238889        0 days 00:00:00
> 227    active 2023-01-25 15:01:54.946614+00:00 2023-01-25 14:08:31.056771+00:00 2023-01-25 15:01:54.946614+00:00 0 days 00:53:23.889843        0 days 00:00:00
> 228    active 2023-01-25 15:09:32.641347+00:00 2023-01-25 15:01:54.946614+00:00 2023-01-25 15:09:32.641347+00:00 0 days 00:07:37.694733        0 days 00:00:00
> 229    active 2023-01-25 16:02:04.919926+00:00 2023-01-25 15:09:32.641347+00:00 2023-01-25 16:02:04.919926+00:00 0 days 00:52:32.278579        0 days 00:00:00
> 230    active 2023-01-25 16:08:29.440442+00:00 2023-01-25 16:02:04.919926+00:00 2023-01-25 16:08:29.440442+00:00 0 days 00:06:24.520516        0 days 00:00:00
> 231    active 2023-01-25 17:02:30.620246+00:00 2023-01-25 16:08:29.440442+00:00 2023-01-25 17:02:30.620246+00:00 0 days 00:54:01.179804        0 days 00:00:00
> 232    active 2023-01-25 17:08:16.111918+00:00 2023-01-25 17:02:30.620246+00:00 2023-01-25 17:08:16.111918+00:00 0 days 00:05:45.491672        0 days 00:00:00
> 233    active 2023-01-25 18:03:09.134952+00:00 2023-01-25 17:08:16.111918+00:00 2023-01-25 18:03:09.134952+00:00 0 days 00:54:53.023034        0 days 00:00:00
> 234    active 2023-01-25 18:07:56.743191+00:00 2023-01-25 18:03:09.134952+00:00 2023-01-25 18:07:56.743191+00:00 0 days 00:04:47.608239        0 days 00:00:00
> 235    active 2023-01-25 19:02:52.698802+00:00 2023-01-25 18:07:56.743191+00:00 2023-01-25 19:02:52.698802+00:00 0 days 00:54:55.955611        0 days 00:00:00
> 236    active 2023-01-25 19:08:09.876675+00:00 2023-01-25 19:02:52.698802+00:00 2023-01-25 19:08:09.876675+00:00 0 days 00:05:17.177873        0 days 00:00:00
> 237    active 2023-01-25 20:01:55.497484+00:00 2023-01-25 19:08:09.876675+00:00 2023-01-25 20:01:55.497484+00:00 0 days 00:53:45.620809        0 days 00:00:00
> ```

## 5. Now compute the hours overlap and uptime/downtime for each `store_id`
> for this we need to calculate the sum of the `active_hours` and `inactive_hours` for each `store_id` and removing `end_extra_time` and `start_extra_time` for the `sum_active_hours` and `sum_inactive_hours`

```python
if not len(sub_status_timerange):
    return [datetime.timedelta(hours=0),
                datetime.timedelta(hours=0)]

sum_active_hours, sum_inactive_hours = sub_status_timerange['active_hours'].sum(),sub_status_timerange['inactive_hours'].sum()

# calculate the time between sub_status_timerange['start_time'] first row and LASK_HR_DATETIME
start_extra_time = LASK_HR_DATETIME - sub_status_timerange['start_time'].iloc[0]
if sub_status_timerange['status'].iloc[0] == 'active':
    sum_active_hours -= start_extra_time
else:
    sum_inactive_hours -= start_extra_time


# # calculate the time between CURRENT_DATETIME_SET and sub_status_timerange['end_time'] last row
end_extra_time = sub_status_timerange['end_time'].iloc[-1] - CURRENT_DATETIME_SET
if sub_status_timerange['status'].iloc[-1] == 'active':
    sum_active_hours -= end_extra_time
else:
    sum_inactive_hours -= end_extra_time
return [sum_active_hours, sum_inactive_hours]
```

> eg: let's take the above example to calculate the `sum_active_hours` and `sum_inactive_hours`
> ```excel
>        status                  timestamp_local                       start_time                         end_time           active_hours         inactive_hours
> 187    active 2023-01-24 20:00:49.407196+00:00 2023-01-24 19:04:28.032808+00:00 2023-01-24 20:00:49.407196+00:00 0 days 00:56:21.374388        0 days 00:00:00
> 188    active 2023-01-24 20:03:37.554265+00:00 2023-01-24 20:00:49.407196+00:00 2023-01-24 20:03:37.554265+00:00 0 days 00:02:48.147069        0 days 00:00:00
> 189    active 2023-01-24 21:00:56.058718+00:00 2023-01-24 20:03:37.554265+00:00 2023-01-24 21:00:56.058718+00:00 0 days 00:57:18.504453        0 days 00:00:00
> 190    active 2023-01-24 21:03:02.379032+00:00 2023-01-24 21:00:56.058718+00:00 2023-01-24 21:03:02.379032+00:00 0 days 00:02:06.320314        0 days 00:00:00
> 191    active 2023-01-24 22:00:53.298806+00:00 2023-01-24 21:03:02.379032+00:00 2023-01-24 22:00:53.298806+00:00 0 days 00:57:50.919774        0 days 00:00:00
> 192    active 2023-01-24 22:03:00.635256+00:00 2023-01-24 22:00:53.298806+00:00 2023-01-24 22:03:00.635256+00:00 0 days 00:02:07.336450        0 days 00:00:00
> 193    active 2023-01-24 23:00:43.975206+00:00 2023-01-24 22:03:00.635256+00:00 2023-01-24 23:00:43.975206+00:00 0 days 00:57:43.339950        0 days 00:00:00
> 194    active 2023-01-24 23:03:39.074389+00:00 2023-01-24 23:00:43.975206+00:00 2023-01-24 23:03:39.074389+00:00 0 days 00:02:55.099183        0 days 00:00:00
> 195    active 2023-01-25 00:00:47.123794+00:00 2023-01-24 23:03:39.074389+00:00 2023-01-25 00:00:47.123794+00:00 0 days 00:57:08.049405        0 days 00:00:00
> 196    active 2023-01-25 00:03:15.622430+00:00 2023-01-25 00:00:47.123794+00:00 2023-01-25 00:03:15.622430+00:00 0 days 00:02:28.498636        0 days 00:00:00
> 197    active 2023-01-25 01:00:38.692156+00:00 2023-01-25 00:03:15.622430+00:00 2023-01-25 01:00:38.692156+00:00 0 days 00:57:23.069726        0 days 00:00:00
> 211  inactive 2023-01-25 07:00:52.899424+00:00 2023-01-25 06:03:16.044936+00:00 2023-01-25 07:00:52.899424+00:00        0 days 00:00:00 0 days 00:57:36.854488
> 212  inactive 2023-01-25 07:03:21.459324+00:00 2023-01-25 07:00:52.899424+00:00 2023-01-25 07:03:21.459324+00:00        0 days 00:00:00 0 days 00:02:28.559900
> 213  inactive 2023-01-25 08:00:47.142792+00:00 2023-01-25 07:03:21.459324+00:00 2023-01-25 08:00:47.142792+00:00        0 days 00:00:00 0 days 00:57:25.683468
> 214  inactive 2023-01-25 08:02:38.811284+00:00 2023-01-25 08:00:47.142792+00:00 2023-01-25 08:02:38.811284+00:00        0 days 00:00:00 0 days 00:01:51.668492
> 215    active 2023-01-25 09:00:55.285348+00:00 2023-01-25 08:02:38.811284+00:00 2023-01-25 09:00:55.285348+00:00 0 days 00:58:16.474064        0 days 00:00:00
> 216    active 2023-01-25 09:02:40.740800+00:00 2023-01-25 09:00:55.285348+00:00 2023-01-25 09:02:40.740800+00:00 0 days 00:01:45.455452        0 days 00:00:00
> 217    active 2023-01-25 10:01:03.896898+00:00 2023-01-25 09:02:40.740800+00:00 2023-01-25 10:01:03.896898+00:00 0 days 00:58:23.156098        0 days 00:00:00
> 218    active 2023-01-25 10:03:11.056959+00:00 2023-01-25 10:01:03.896898+00:00 2023-01-25 10:03:11.056959+00:00 0 days 00:02:07.160061        0 days 00:00:00
> 219    active 2023-01-25 11:01:03.078580+00:00 2023-01-25 10:03:11.056959+00:00 2023-01-25 11:01:03.078580+00:00 0 days 00:57:52.021621        0 days 00:00:00
> 220    active 2023-01-25 11:03:30.092721+00:00 2023-01-25 11:01:03.078580+00:00 2023-01-25 11:03:30.092721+00:00 0 days 00:02:27.014141        0 days 00:00:00
> 221    active 2023-01-25 12:00:43.791570+00:00 2023-01-25 11:03:30.092721+00:00 2023-01-25 12:00:43.791570+00:00 0 days 00:57:13.698849        0 days 00:00:00
> 222    active 2023-01-25 12:04:23.893717+00:00 2023-01-25 12:00:43.791570+00:00 2023-01-25 12:04:23.893717+00:00 0 days 00:03:40.102147        0 days 00:00:00
> 223    active 2023-01-25 13:01:19.762596+00:00 2023-01-25 12:04:23.893717+00:00 2023-01-25 13:01:19.762596+00:00 0 days 00:56:55.868879        0 days 00:00:00
> 224    active 2023-01-25 13:04:24.219942+00:00 2023-01-25 13:01:19.762596+00:00 2023-01-25 13:04:24.219942+00:00 0 days 00:03:04.457346        0 days 00:00:00
> 225    active 2023-01-25 14:02:25.817882+00:00 2023-01-25 13:04:24.219942+00:00 2023-01-25 14:02:25.817882+00:00 0 days 00:58:01.597940        0 days 00:00:00
> 226    active 2023-01-25 14:08:31.056771+00:00 2023-01-25 14:02:25.817882+00:00 2023-01-25 14:08:31.056771+00:00 0 days 00:06:05.238889        0 days 00:00:00
> 227    active 2023-01-25 15:01:54.946614+00:00 2023-01-25 14:08:31.056771+00:00 2023-01-25 15:01:54.946614+00:00 0 days 00:53:23.889843        0 days 00:00:00
> 228    active 2023-01-25 15:09:32.641347+00:00 2023-01-25 15:01:54.946614+00:00 2023-01-25 15:09:32.641347+00:00 0 days 00:07:37.694733        0 days 00:00:00
> 229    active 2023-01-25 16:02:04.919926+00:00 2023-01-25 15:09:32.641347+00:00 2023-01-25 16:02:04.919926+00:00 0 days 00:52:32.278579        0 days 00:00:00
> 230    active 2023-01-25 16:08:29.440442+00:00 2023-01-25 16:02:04.919926+00:00 2023-01-25 16:08:29.440442+00:00 0 days 00:06:24.520516        0 days 00:00:00
> 231    active 2023-01-25 17:02:30.620246+00:00 2023-01-25 16:08:29.440442+00:00 2023-01-25 17:02:30.620246+00:00 0 days 00:54:01.179804        0 days 00:00:00
> 232    active 2023-01-25 17:08:16.111918+00:00 2023-01-25 17:02:30.620246+00:00 2023-01-25 17:08:16.111918+00:00 0 days 00:05:45.491672        0 days 00:00:00
> 233    active 2023-01-25 18:03:09.134952+00:00 2023-01-25 17:08:16.111918+00:00 2023-01-25 18:03:09.134952+00:00 0 days 00:54:53.023034        0 days 00:00:00
> 234    active 2023-01-25 18:07:56.743191+00:00 2023-01-25 18:03:09.134952+00:00 2023-01-25 18:07:56.743191+00:00 0 days 00:04:47.608239        0 days 00:00:00
> 235    active 2023-01-25 19:02:52.698802+00:00 2023-01-25 18:07:56.743191+00:00 2023-01-25 19:02:52.698802+00:00 0 days 00:54:55.955611        0 days 00:00:00
> 236    active 2023-01-25 19:08:09.876675+00:00 2023-01-25 19:02:52.698802+00:00 2023-01-25 19:08:09.876675+00:00 0 days 00:05:17.177873        0 days 00:00:00
> 237    active 2023-01-25 20:01:55.497484+00:00 2023-01-25 19:08:09.876675+00:00 2023-01-25 20:01:55.497484+00:00 0 days 00:53:45.620809        0 days 00:00:00
> ```
> **`uptime_last_day` = 0 days 16:57:59.880872**
>
> **`downtime_last_day` = 0 days 01:59:22.766348**
>
> symillarly for last 7 days and last 1 hour